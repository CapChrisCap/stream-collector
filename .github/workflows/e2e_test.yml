name: "e2e test"

#on:
#  workflow_run:
#    workflows: ["build"]
#    types:
#      - completed

on: push

jobs:
  run_e2e:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - uses: coursier/cache-action@v3
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Get current version
        id: ver
        run: |
          export PROJECT_VERSION=$(grep 'version :=' build.sbt|awk -F'"' '{print $2}')
          echo "::set-output name=project_version::$PROJECT_VERSION"
      - name: Get tf modules branch
        id: branch
        run: |
          if [[ ${{ steps.ver.outputs.project_version }} =~ '\d+.\d+.\d+' ]]
            then
              export BRANCH=master
            else
              export BRANCH="feature/collector/${{ steps.ver.outputs.project_version }}"
          fi
          echo "::set-output name=branch::BRANCH"
          env
      - name: invoke deployment service
        run: >
          curl -X POST "https://deployment-service-next.snplow.net/v1/deployment"
          -H  "accept: application/json"
          -H  "X-Token: ${{ secrets.GITHUB_TOKEN }}"
          -H  "Content-Type: application/json"
          -d "{
            \"type\": \"tests/gcp_e2e\",
            \"version\": \"0.1.0\",
            \"customer\": \"NA\",
            \"environment\": \"NA\",
            \"dry_run\": false,
            \"github_ref\": ${{ steps.branch.outputs.branch }}
          }"
